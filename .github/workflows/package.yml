on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  package:
    name: MyFileServer
    runs-on: ubuntu-latest

    steps:
      - name: Setup node-js
        uses: actions/setup-node@v4
        with: 
            node-version: 24
            cache: 'npm'
            cache-dependency-path: ./frontend/package-lock.json

      - name: Checkout master repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config --global user.name "Akshay Nile"
          git config --global user.email "akshaynile8849@gmail.com"

      - name: Create orphan package branch
        run: git checkout --orphan package

      - name: Build frontend dist
        working-directory: ./frontend
        run: |
          npm ci
          npm run build
          if [ ! -d "dist" ]; then
            echo "Frontend build failed."
            exit 1
          fi
          
      - name: Setup MyFileServer package
        working-directory: ./
        run: |
          mv ./backend ./MyFileServer
          mv ./frontend/dist ./MyFileServer/public
          mv ./scripts/uninstall.ps1 ./MyFileServer
          printf "%s" "$(grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' README.md | sed 's/^v//')" > ./MyFileServer/version.txt

      - name: Clean-up unnecessary junk
        working-directory: ./
        run: |
          find . -mindepth 1 -maxdepth 1 \
            ! -name 'MyFileServer' \
            ! -name '.git' \
            -exec rm -rf {} +

      - name: Commit and push package branch
        working-directory: ./
        run: |
          git add .
          git commit -m "Automated Package Build"
          git push origin package --force
